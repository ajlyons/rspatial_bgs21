<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Spatial Queries &amp; Joins  " />
  <meta name="copyright" content="<span class='footer-right'><a href='../acknowledgements.html'>Acknowledgements</a></span><span class='footer-right'><a href=' https://etherpad.wikimedia.org/p/rspatial-bgs21 ' target='_blank'>Forum</a></span><span class='footer-right'><a href=' https://ajlyons.github.io/rspatial_bgs21 '> https://ajlyons.github.io/rspatial_bgs21 </a></span><span class='footer-right'><a href='../index.html'>Home</a></span><span class='footer-subtitle'> Spatial Data Analysis with R </span>"/>
  <meta name="font-size-adjustment" content="2"/>
  <title>Spatial Data Analysis with R  BayGeo, Spring 2021</title>
  <style type="text/css">
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
            pre > code.sourceCode { white-space: pre; position: relative; }
            pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
            pre > code.sourceCode > span:empty { height: 1.2em; }
            code.sourceCode > span { color: inherit; text-decoration: inherit; }
            div.sourceCode { margin: 1em 0; }
            pre.sourceCode { margin: 0; }
            @media screen {
            div.sourceCode { overflow: auto; }
            }
            @media print {
            pre > code.sourceCode { white-space: pre-wrap; }
            pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
            }
            pre.numberSource code
              { counter-reset: source-line 0; }
            pre.numberSource code > span
              { position: relative; left: -4em; counter-increment: source-line; }
            pre.numberSource code > span > a:first-child::before
              { content: counter(source-line);
                position: relative; left: -1em; text-align: right; vertical-align: baseline;
                border: none; display: inline-block;
                -webkit-touch-callout: none; -webkit-user-select: none;
                -khtml-user-select: none; -moz-user-select: none;
                -ms-user-select: none; user-select: none;
                padding: 0 4px; width: 4em;
                color: #aaaaaa;
              }
            pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
            div.sourceCode
              {   }
            @media screen {
            pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
            }
            code span.al { color: #ff0000; font-weight: bold; } /* Alert */
            code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
            code span.at { color: #7d9029; } /* Attribute */
            code span.bn { color: #40a070; } /* BaseN */
            code span.bu { } /* BuiltIn */
            code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
            code span.ch { color: #4070a0; } /* Char */
            code span.cn { color: #880000; } /* Constant */
            code span.co { color: #60a0b0; font-style: italic; } /* Comment */
            code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
            code span.do { color: #ba2121; font-style: italic; } /* Documentation */
            code span.dt { color: #902000; } /* DataType */
            code span.dv { color: #40a070; } /* DecVal */
            code span.er { color: #ff0000; font-weight: bold; } /* Error */
            code span.ex { } /* Extension */
            code span.fl { color: #40a070; } /* Float */
            code span.fu { color: #06287e; } /* Function */
            code span.im { } /* Import */
            code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
            code span.kw { color: #007020; font-weight: bold; } /* Keyword */
            code span.op { color: #666666; } /* Operator */
            code span.ot { color: #007020; } /* Other */
            code span.pp { color: #bc7a00; } /* Preprocessor */
            code span.sc { color: #4070a0; } /* SpecialChar */
            code span.ss { color: #bb6688; } /* SpecialString */
            code span.st { color: #4070a0; } /* String */
            code span.va { color: #19177c; } /* Variable */
            code span.vs { color: #4070a0; } /* VerbatimString */
            code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
          </style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACkUlEQVQ4jX2SW0jTcRTHTzNyeZlh6lqmm3POdNPC6SxSEzaqafkykOFoIxTDWpKRFV6iQMNLFyMSsQvUW0WORc2WWBmGKEGZXUyz0NrmNmfa1PYgfHsQ1v5oHjgvX875/M45vy/R8mDJ9caxrFIL5CUWJB00Q9n+7Q+l1BetUMuMTL3JpTB0QVnejd1Hu9DQ60G5eQbqB7PIvj0L2bUZ0KZzghWbs0o7Fx3Tc/B6vStm6+g0wrQvIKh2gKKyUxnNSZoO685SC1YDeL1e9Ll+Ia7WCd5pJ4hojQ8g1nViezETYBqZx93BOdwa9jAgsdUT4J6ZQqC6f4GIiLYU9/RzNWYIdU9hd/8rLjN7UGT8DbWROVVMlQsBBWas142DiIikdfbFMF0POIVm2NzM1zwLS+mvcSsnEajpBSv/8RIgucGJ1EYXEs+NwjrlWfUGMee/Y2PFJIJLrFibex8kOsahhCYnUlpnIL1kh9X9/yMKG2yIOOlAsPYnAveZsE75EEQUQLwTwy5Rsxvx9UxApKEPEYY+BiSizA623oaggkdgq4xLKwRLq7i8sy6EFlpg8wNEVwyAd3wAbZ8cPu3CazeCC/sRojYjaL8Jvm8MPWLDBm03A8CveQ9+7RBia4cYU4QfeokwzTOwc6/4OzKXHap/C5ufD0RNo0i4OAZR81dcnnD69Mp3PxBe9GRkuZdFKk7sqTcQ132EpGUMydetSLnpgOSGHVtbxpHU9AX8mkFEG55/ZrjQL1h82V6esPLVh8Sr40i940J6xzzS7s1C0m6HqHEEiTnatgT5gcPijHxltFwhjpRIQpZjBAJ2lFTBFW5TiOPT8mXx6apdcRl5OaJM1Q6hLC9ls3RPTLgok0NELCKiv02kPqt/O1MZAAAAAElFTkSuQmCC" rel="icon" type="image/x-icon" />
  <script language="javascript" type="text/javascript">
  function TriShowHide(shID) {
    shIDspan = shID + "span";
    shIDdiv = shID + "div";
    if (document.getElementById(shIDdiv).style.display != 'block') {
      document.getElementById(shIDdiv).style.display = 'block';
      txtSpan = "&#9660;";
    } else {
      document.getElementById(shIDdiv).style.display = 'none';
      txtSpan = "&#9654;";
    }
    document.getElementById(shIDspan).innerHTML = txtSpan + " ";
  }
  function showHide(shID) {
    if (shID=="soln-show-all") {
      var allAnswerCode = document.getElementsByClassName("answer-code");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'block';
      }
    } else if (shID=="soln-hide-all") {
      var allAnswerCode = document.getElementsByClassName("answer-code");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'none';
      }
    } else if (shID=="hints-show-all") {
      var allAnswerCode = document.getElementsByClassName("hint");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'block';
      }
    } else if (shID=="hints-hide-all") {
      var allAnswerCode = document.getElementsByClassName("hint");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'none';
      }
    } else {
      if (document.getElementById(shID)) {
        if (document.getElementById(shID).style.display != 'block') {
          document.getElementById(shID).style.display = 'block';
        } else {
          document.getElementById(shID).style.display = 'none';
        }
      }
    }
  }
  function CopyToClipboard(containerid) {
  if (document.selection) {
      var range = document.body.createTextRange();
      range.moveToElementText(document.getElementById(containerid));
      range.select().createTextRange();
      document.execCommand("copy");
  } else if (window.getSelection) {
      var range = document.createRange();
      range.selectNode(document.getElementById(containerid));
      window.getSelection().addRange(range);
      document.execCommand("copy");
      // alert("text copied")
  }}
  </script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-163964617-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-163964617-1');
  </script>
  <script src="lib/header-attrs-2.6/header-attrs.js"></script>
  <link href="lib/slidy-2/styles/slidy.css" rel="stylesheet" />
  <script src="lib/slidy-2/scripts/slidy.js"></script>
  <script src="lib/slidy_shiny-1/slidy_shiny.js"></script>
  <script src="lib/clipboard-1.7.1/clipboard.min.js"></script>
  <link href="lib/primer-tooltips-1.4.0/build.css" rel="stylesheet" />
  <link href="lib/klippy-0.0.0.9500/css/klippy.min.css" rel="stylesheet" />
  <script src="lib/klippy-0.0.0.9500/js/klippy.min.js"></script>
  <script src="lib/kePrint-0.0.1/kePrint.js"></script>
  <link href="lib/lightable-0.0.1/lightable.css" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
   href="../css/slidy_styles.css" />
  <meta name="duration" content="0" />
</head>
<body>
<div class="slide titlepage">
  <h1 class="title"><span class="course-title">Spatial Data Analysis with R </span><br/><span class="course-subtitle">BayGeo, Spring 2021</span></h1>
  <p class="author">
Spatial Queries &amp; Joins <br/><img src='images/spatial_query_410x310.png'/>
  </p>
</div>
<div id="spatial-queries" class="slide section level1">
<h1>Spatial Queries</h1>
<script language="javascript" type="text/javascript">w3c_slidy.mouse_click_enabled = false;</script>
<script>
  addKlippy('left', 'top', 'auto', '1', 'Copy code', 'Copied!');
</script>
<p>Spatial query = <strong>selecting</strong> features based on their <strong>location</strong> or <strong>spatial relationship</strong> (relative to another feature)</p>
<div class="infobox">
<p>Spatial Querying is also known as <em>Spatial Subsetting</em></p>
</div>
<p>Spatial relationship functions in <code>sf</code>:</p>
<table class="tbl_compact">
<tbody>
<tr>
<td style="text-align:left;font-family: monospace;">
st_intersects()
</td>
<td style="text-align:left;">
overlaps or touches
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_disjoint()
</td>
<td style="text-align:left;">
opposite of intersect
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_touches()
</td>
<td style="text-align:left;">
touches only
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_crosses()
</td>
<td style="text-align:left;">
cross (but doesn’t touch)
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_within()
</td>
<td style="text-align:left;">
within
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_contains()
</td>
<td style="text-align:left;">
contains
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_contains_properly()
</td>
<td style="text-align:left;">
interiors intersect but not edges or exterior
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_overlaps()
</td>
<td style="text-align:left;">
overlaps
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_equals()
</td>
<td style="text-align:left;">
equals
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_covers()
</td>
<td style="text-align:left;">
covers
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_covered_by()
</td>
<td style="text-align:left;">
completely covered
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_equals_exact()
</td>
<td style="text-align:left;">
equals within a tolerance
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_is_within_distance()
</td>
<td style="text-align:left;">
within a distance
</td>
</tr>
</tbody>
</table>
<div class="infobox">
<p>These functions are also known as <strong>spatial predicates</strong>.</p>
<p>These are <strong>logical</strong> functions - they return TRUE/FALSE values (and/or or row numbers).</p>
<p>Spatial proximity functions require that layers be in the <strong>same CRS</strong>.</p>
</div>
<!--- infobox --->
</div>
<div id="using-logical-spatial-relationship-functions" class="slide section level1">
<h1>Using Logical Spatial Relationship Functions</h1>
<p>Let’s look at an example:</p>
<div class="indented2" style="font-family:monospace;">
<strong>st_intersects(<em>x</em>, <em>y</em>, sparse=TRUE)</strong>
</div>
<p>where</p>
<div class="indented2">
<p><code>x</code> (target) and <code>y</code> (source) are both <code>sf</code> objects</p>
<code>sparse = TRUE</code><br />

<div class="compact">
<ul>
<li>function returns a <strong>list</strong> object with<br />
</li>
<li>one element for each feature of <code>x</code>, and<br />
</li>
<li>each element contains the <strong>indices of y</strong> where the test is TRUE</li>
</ul>
</div>
<p><br />
</p>
<code>sparse = FALSE</code><br />

<div class="compact">
<ul>
<li>function returns a <strong>matrix</strong> of <strong>logical values</strong>, with<br />
</li>
<li>one row for each feature of <code>x</code>, and<br />
</li>
<li>one column for each features in <code>y</code></li>
</ul>
</div>
</div>
<!---- class = indented2 ---->
<p><br />
</p>
<h3 id="example-points-and-polygons">Example: Points and Polygons</h3>
<p>Consider an example where <code>x</code> contains 5 points and <code>y</code> contains 2 polygons:</p>
<p><img src="spatial-queries_files/figure-slidy/show_graphic-1.png" width="768" /></p>
<p>When <code>sparse = TRUE</code>, you get a <strong>list of indices</strong>:</p>
<div class="indented4 indented2r">
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">st_intersects</span>(my_pts, my_polys, <span class="dt">sparse =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<pre><code>## Sparse geometry binary predicate list of length 5, where the predicate was `intersects&#39;
##  1: (empty)
##  2: 1
##  3: (empty)
##  4: 2
##  5: (empty)</code></pre>
</div>
<p>When <code>sparse = FALSE</code>, you get a <em>2 x 5</em> <strong>matrix of logical values</strong>:</p>
<div class="indented4 indented2r">
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">st_intersects</span>(my_pts, my_polys, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<pre><code>##       [,1]  [,2]
## [1,] FALSE FALSE
## [2,]  TRUE FALSE
## [3,] FALSE FALSE
## [4,] FALSE  TRUE
## [5,] FALSE FALSE</code></pre>
</div>
<div class="infobox">
<p>When you get back the results of a spatial relationship test, you can use them to subset features with <code>dplyr</code> functions:</p>
<div class="indented1">
<ul>
<li>feed TRUE / FALSE values into <code>filter()</code></li>
<li>feed row numbers into <code>slice()</code></li>
</ul>
</div>
</div>
<!--- infobox--->
<p><br />
</p>
</div>
<div id="example-find-yosemite-pois-that-intersect-the-merced-watershed" class="slide section level1">
<h1>Example: Find Yosemite POIs that Intersect the Merced Watershed</h1>
<!---- # R Notebook Exercise 1 --->
<p>Open <span style='font-style:italic;'>nb_spatial-qry01.Rmd</span></p> <div class="indented2" style="font-style:italic; font-size:90%; border:1px dashed lightgray; width:600px; overflow:hidden; padding:10px;"> <img src="images/download-rmd-btn_140x136x256.png" style="float:right; padding:5px; width:140px; height:136px;"/> <p>If you don't have it, you can get it <a href="https://ucanr-igis.github.io/rspatial_data/nb_spatial-qry01.nb.html" target="_blank" rel="noopener" style="font-weight:bold;">here</a>.</p><p>Click the 'code' button in the upper-right and select 'Download Rmd'.</p> </div>
<p>Start by importing the watersheds:</p>
<div class="indented4 indented2r">
<div class="sourceCode" id="cb5"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">## Import the watersheds, grouping by HUNAME</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>gpkg_watershd_fn &lt;-<span class="st"> &quot;./data/yose_watersheds.gpkg&quot;</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>yose_hu_watersheds &lt;-<span class="st"> </span><span class="kw">st_read</span>(gpkg_watershd_fn, <span class="dt">layer=</span><span class="st">&quot;calw221&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="st">  </span><span class="kw">group_by</span>(HU) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">HUNAME =</span> <span class="kw">first</span>(HUNAME), <span class="dt">NUM_WATERSHEDS =</span> <span class="kw">n</span>())</span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co">## Pull out just the merced water</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>merced_watershed &lt;-<span class="st"> </span>yose_hu_watersheds <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">filter</span>(HUNAME <span class="op">==</span><span class="st"> &quot;MERCED RIVER&quot;</span>)</span>
<span id="cb5-9"><a href="#cb5-9"></a></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="co">## Plot boundaries</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="kw">plot</span>(yose_hu_watersheds <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_geometry</span>())</span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="kw">plot</span>(merced_watershed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_geometry</span>(), <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">col=</span><span class="st">&quot;lightpink&quot;</span>)</span></code></pre></div>
<pre><code>## Reading layer `calw221&#39; from data source `D:\Workshops\R-Spatial\rspatial_mod\outputs\rspatial_data\data\yose_watersheds.gpkg&#39; using driver `GPKG&#39;
## Simple feature collection with 127 features and 38 fields
## geometry type:  POLYGON
## dimension:      XY
## bbox:           xmin: 1383.82 ymin: -61442.93 xmax: 81596.71 ymax: 26405.66
## projected CRS:  unnamed</code></pre>
<p><img src="spatial-queries_files/figure-slidy/watershed_imp_klippy-1.png" width="768" /></p>
</div>
<p>Next import the points of interest:</p>
<div class="indented4 indented2r">
<div class="sourceCode" id="cb7"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co">## Import points of interest</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>yose_poi &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn=</span><span class="st">&quot;./data&quot;</span>, <span class="dt">layer=</span><span class="st">&quot;yose_poi&quot;</span>) </span></code></pre></div>
<pre><code>## Reading layer `yose_poi&#39; from data source `D:\Workshops\R-Spatial\rspatial_mod\outputs\rspatial_data\data&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 2720 features and 30 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: 246416.2 ymin: 4153717 xmax: 301510.7 ymax: 4208419
## projected CRS:  NAD83 / UTM zone 11N</code></pre>
</div>
<p>Test for intersection:</p>
<div class="indented4 indented2r">
<div class="sourceCode" id="cb9"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>merced_poi &lt;-<span class="st"> </span>yose_poi <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_intersects</span>(merced_watershed)</span></code></pre></div>
<pre><code>## Error in st_geos_binop(&quot;intersects&quot;, x, y, sparse = sparse, prepared = prepared, : st_crs(x) == st_crs(y) is not TRUE</code></pre>
</div>
<div class="indented2" style="color:red;font-weight:bold;">
<p>Spatial querying requires features to be in the same crs!</p>
</div>
<p>In this case, let’s project the HU watershed layer (which is in Albers) to match the points of interest (which are UTM):</p>
<div class="indented4 indented2r">
<div class="sourceCode" id="cb11"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>yose_hu_utm &lt;-<span class="st"> </span>yose_hu_watersheds <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="kw">st_crs</span>(yose_poi))</span>
<span id="cb11-2"><a href="#cb11-2"></a>merced_hu_utm &lt;-<span class="st"> </span>yose_hu_utm <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">filter</span>(HUNAME <span class="op">==</span><span class="st"> &quot;MERCED RIVER&quot;</span>)</span></code></pre></div>
</div>
<div class="tip">
<p>Note the trick here: rather than projecting the watersheds to a specific EPSG number, we project it to match whatever projection <code>yose_poi</code> is in. We don’t even need to know what it is!</p>
</div>
<!--- tip --->
<p>Try the intersects test again:</p>
<div class="indented4 indented2r">
<div class="sourceCode" id="cb12"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>yose_poi_merced_yn &lt;-<span class="st"> </span>yose_poi <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_intersects</span>(merced_hu_utm, <span class="dt">sparse=</span><span class="ot">FALSE</span>)</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="kw">head</span>(yose_poi_merced_yn)</span></code></pre></div>
<pre><code>##      [,1]
## [1,] TRUE
## [2,] TRUE
## [3,] TRUE
## [4,] TRUE
## [5,] TRUE
## [6,] TRUE</code></pre>
</div>
<div class="tryit">
<p>How many points intersect the Merced watershed polygon?</p>
<p>[<span id="soln_oorhdz" class="showhidesoln" onclick="showHide(&#39;oorhdz&#39;);return false;">Hint</span>] [<span id="soln_pyibqe" class="showhidesoln" onclick="showHide(&#39;pyibqe&#39;);return false;">Solution</span>]</p>
<div id="oorhdz" class="hint">
<p>This is equivalent to asking how many TRUE values there are in the first column of <code>yose_poi_merced_yn</code>.</p>
<p>To get the first column of a matrix <code>x</code>, use <code>x[ , 1]</code></p>
</div>
<!--- soln_oorhdz --->
<div id="pyibqe" class="hint">
<div class="indented1 indentend1-r">
<div class="sourceCode" id="cb14"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="co">## Sum up the values in the matrix</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="kw">sum</span>(yose_poi_merced_yn[,<span class="dv">1</span>])</span>
<span id="cb14-3"><a href="#cb14-3"></a></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="co">## Or you can compute a frequency table of values in the matrix</span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="kw">table</span>(yose_poi_merced_yn[,<span class="dv">1</span>])</span></code></pre></div>
<pre><code>## [1] 2233
## 
## FALSE  TRUE 
##   487  2233</code></pre>
</div>
</div>
<!--- soln_pyibqe --->
</div>
<!--- TryIt --->
<p>Plot the results to make sure:</p>
<div class="indented4 indented2r">
<div class="sourceCode" id="cb16"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co">## Extract the points that intersect the watershed to a new sf object</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>merced_poi &lt;-<span class="st"> </span>yose_poi <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(yose_poi_merced_yn[,<span class="dv">1</span>])</span>
<span id="cb16-3"><a href="#cb16-3"></a></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="co">## Plot</span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="kw">plot</span>(yose_hu_utm  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_geometry</span>(), <span class="dt">border=</span><span class="st">&quot;gray70&quot;</span>)</span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="kw">plot</span>(merced_hu_utm <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_geometry</span>(), <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">col=</span><span class="st">&quot;lightpink&quot;</span>)</span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="kw">plot</span>(yose_poi <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_geometry</span>(), <span class="dt">col=</span><span class="st">&quot;gray30&quot;</span>, <span class="dt">pch=</span><span class="dv">16</span>, <span class="dt">cex=</span><span class="fl">0.5</span>, <span class="dt">add=</span><span class="ot">TRUE</span>)</span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="kw">plot</span>(merced_poi <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_geometry</span>(), <span class="dt">col=</span><span class="st">&quot;darkgreen&quot;</span>, <span class="dt">pch=</span><span class="dv">16</span>, <span class="dt">cex=</span><span class="fl">0.8</span>, <span class="dt">add=</span><span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="spatial-queries_files/figure-slidy/watershed_poi_plot_klippy-1.png" width="768" /></p>
</div>
<div class="infobox">
<p><strong>Selecting with Square Bracket Notation</strong></p>
<p>You can also subset spatially use the familiar square bracket notation, putting a sf object as the expression for the rows. The following are equivalent:</p>
<div class="indented4 indented2r">
<div class="sourceCode" id="cb17"><pre class="sourceCode r sample_code"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>poi_merced2 &lt;-<span class="st"> </span>yose_poi <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_intersection</span>(merced_hu_utm)</span>
<span id="cb17-2"><a href="#cb17-2"></a>poi_merced1 &lt;-<span class="st"> </span>yose_poi[merced_hu_utm, ]</span></code></pre></div>
</div>
<p>By default, when the rows argument is a sf object the result will be an intersection. To use a different spatial test, add the optional <code>op</code> argument:</p>
<div class="indented1 indented1-r">
<div class="sourceCode" id="cb18"><pre class="sourceCode r sample_code"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co">## Get all the points of interest *except* where they intersect</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="co">## Note the blank space where the &#39;columns&#39; expression should normally go.</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="co">## You still need that comma!</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>poi_not_merced &lt;-<span class="st"> </span>yose_poi[merced_hu_utm, , op =<span class="st"> </span>st_disjoint]</span></code></pre></div>
</div>
</div>
<!--- info-box --->
<!---- # Example: Select features in a bounding box --->
</div>
<div id="example-generating-random-points" class="slide section level1">
<h1>Example: Generating Random Points</h1>
<p>In this example, we want to generate 500 random points. Because Yosemite is not rectangular, our approach will be:</p>
<ol style="list-style-type: decimal">
<li>generate a whole bunch of random points within the bounding box (which is easy to do)<br />
</li>
<li>filter out the points that fall outside the park boundary<br />
</li>
<li>randomly select 500 from the ones within the park</li>
</ol>
<p>First, we import the boundary and generate 1500 points within the bounding box.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co">## Import the Yosemite border</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>yose_bnd_ll &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn=</span><span class="st">&quot;./data&quot;</span>, <span class="dt">layer=</span><span class="st">&quot;yose_boundary&quot;</span>)</span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="co">## Generate uniformly distributed random numbers between the x and y ranges</span></span>
<span id="cb19-5"><a href="#cb19-5"></a>n &lt;-<span class="st"> </span><span class="dv">500</span></span>
<span id="cb19-6"><a href="#cb19-6"></a>yose_ext &lt;-<span class="st"> </span><span class="kw">st_bbox</span>(yose_bnd_ll)</span>
<span id="cb19-7"><a href="#cb19-7"></a>xs &lt;-<span class="st"> </span><span class="kw">runif</span>(n <span class="op">*</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">min =</span> yose_ext[<span class="dv">1</span>], <span class="dt">max =</span> yose_ext[<span class="dv">3</span>])</span>
<span id="cb19-8"><a href="#cb19-8"></a>ys &lt;-<span class="st"> </span><span class="kw">runif</span>(n <span class="op">*</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">min =</span> yose_ext[<span class="dv">2</span>], <span class="dt">max =</span> yose_ext[<span class="dv">4</span>])</span>
<span id="cb19-9"><a href="#cb19-9"></a></span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="co">## Create a sf object from the random points</span></span>
<span id="cb19-11"><a href="#cb19-11"></a>rand_pts &lt;-<span class="st"> </span><span class="kw">st_as_sf</span>(<span class="kw">data.frame</span>(<span class="dt">lon =</span> xs, <span class="dt">lat =</span> ys), </span>
<span id="cb19-12"><a href="#cb19-12"></a>                     <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>), </span>
<span id="cb19-13"><a href="#cb19-13"></a>                     <span class="dt">crs=</span><span class="kw">st_crs</span>(yose_bnd_ll))</span>
<span id="cb19-14"><a href="#cb19-14"></a></span>
<span id="cb19-15"><a href="#cb19-15"></a><span class="co">## Plot</span></span>
<span id="cb19-16"><a href="#cb19-16"></a><span class="kw">plot</span>(rand_pts, <span class="dt">axes=</span>T, <span class="dt">pch=</span><span class="dv">16</span>, <span class="dt">cex=</span><span class="fl">0.5</span>)</span></code></pre></div>
<p><img src="spatial-queries_files/figure-slidy/rand_pts-1.png" width="768" /></p>
<p>Next, we test which points fall within the park boundary, and save those to a new object.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="co">## Test which points are within the YNP boundary</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>in_yose_mat &lt;-<span class="st"> </span><span class="kw">st_within</span>(rand_pts, yose_bnd_ll, <span class="dt">sparse =</span> <span class="ot">FALSE</span>)</span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="kw">head</span>(in_yose_mat)</span>
<span id="cb20-4"><a href="#cb20-4"></a></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="co">## Save those in the park to a new sf object</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>pts_in_park &lt;-<span class="st"> </span>rand_pts <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(in_yose_mat[,<span class="dv">1</span>])</span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="kw">nrow</span>(pts_in_park)</span>
<span id="cb20-8"><a href="#cb20-8"></a></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="kw">tm_shape</span>(yose_bnd_ll) <span class="op">+</span><span class="st"> </span><span class="kw">tm_borders</span>(<span class="dt">col=</span><span class="st">&quot;palegreen4&quot;</span>, <span class="dt">lwd =</span> <span class="dv">4</span>) <span class="op">+</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="st">  </span><span class="kw">tm_shape</span>(pts_in_park) <span class="op">+</span><span class="st"> </span><span class="kw">tm_dots</span>(<span class="dt">size =</span> <span class="fl">0.1</span>, <span class="dt">col=</span><span class="st">&quot;gray20&quot;</span>)</span></code></pre></div>
<p><img src="spatial-queries_files/figure-slidy/test_within_park-1.png" width="768" /></p>
<pre><code>##      [,1]
## [1,] TRUE
## [2,] TRUE
## [3,] TRUE
## [4,] TRUE
## [5,] TRUE
## [6,] TRUE
## [1] 982</code></pre>
<p>Lastly, all we need is 500 points so take a random sample:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co">## Take a random sample of the points </span></span>
<span id="cb22-2"><a href="#cb22-2"></a>pts_in_park_<span class="dv">500</span> &lt;-<span class="st"> </span>pts_in_park <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sample_n</span>(n)</span>
<span id="cb22-3"><a href="#cb22-3"></a></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="co">## Plot</span></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="kw">tm_shape</span>(yose_bnd_ll) <span class="op">+</span><span class="st"> </span><span class="kw">tm_borders</span>(<span class="dt">col=</span><span class="st">&quot;palegreen4&quot;</span>, <span class="dt">lwd =</span> <span class="dv">4</span>) <span class="op">+</span></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="st">  </span><span class="kw">tm_shape</span>(pts_in_park_<span class="dv">500</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_dots</span>(<span class="dt">size =</span> <span class="fl">0.1</span>, <span class="dt">col =</span> <span class="st">&quot;gray20&quot;</span>)</span></code></pre></div>
<p><img src="spatial-queries_files/figure-slidy/sample500-1.png" width="768" /></p>
</div>
<div id="computing-distances-and-identifying-nearest-neighbors" class="slide section level1">
<h1>Computing Distances and Identifying Nearest Neighbors</h1>
<p><code>sf::st_distance()</code> computes distances <strong>between all pairs of features</strong>. For example, if you wanted to compute the distance from every campground to every cell tower.</p>
To identify one or more nearest neighbors, use <code>**st_nn()**</code> from the <strong>nngeo</strong> package.
<div class="tip">
<p>When computing feature-to-feature distances or identifying nearest neighbors, the layers should be in the same CRS.</p>
</div>
<!--- tip --->
<h3 id="example-find-the-closest-trail-to-each-campground">Example: Find the closest trail to each campground</h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co">## FIND THE CLOSEST TRAIL TO EACH CAMPGROUND</span></span>
<span id="cb23-2"><a href="#cb23-2"></a></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="co">## Define a convenience variable for UTM Zone 11</span></span>
<span id="cb23-4"><a href="#cb23-4"></a>epsg_utm11n_nad83 &lt;-<span class="st"> </span><span class="dv">26911</span></span>
<span id="cb23-5"><a href="#cb23-5"></a></span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="co">## Import the campgrounds</span></span>
<span id="cb23-7"><a href="#cb23-7"></a>yose_campgrnds_utm &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn=</span><span class="st">&quot;./data&quot;</span>, <span class="dt">layer=</span><span class="st">&quot;yose_poi&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(POITYPE <span class="op">==</span><span class="st"> &#39;Campground&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(POINAME) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb23-10"><a href="#cb23-10"></a><span class="st">  </span><span class="kw">st_transform</span>(epsg_utm11n_nad83)</span>
<span id="cb23-11"><a href="#cb23-11"></a></span>
<span id="cb23-12"><a href="#cb23-12"></a><span class="co">## Import the trails</span></span>
<span id="cb23-13"><a href="#cb23-13"></a>gdb_fn &lt;-<span class="st"> &quot;./data/yose_trails.gdb&quot;</span></span>
<span id="cb23-14"><a href="#cb23-14"></a><span class="kw">file.exists</span>(gdb_fn)</span>
<span id="cb23-15"><a href="#cb23-15"></a>yose_trails_utm &lt;-<span class="st"> </span><span class="kw">st_read</span>(gdb_fn, <span class="dt">layer=</span><span class="st">&quot;Trails&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb23-16"><a href="#cb23-16"></a><span class="st">  </span><span class="kw">st_transform</span>(epsg_utm11n_nad83)</span>
<span id="cb23-17"><a href="#cb23-17"></a></span>
<span id="cb23-18"><a href="#cb23-18"></a><span class="co">## Load the nngeo package</span></span>
<span id="cb23-19"><a href="#cb23-19"></a><span class="kw">library</span>(nngeo)</span>
<span id="cb23-20"><a href="#cb23-20"></a></span>
<span id="cb23-21"><a href="#cb23-21"></a><span class="co">## Run the st_nn, return results as list</span></span>
<span id="cb23-22"><a href="#cb23-22"></a>closest_trail_lst &lt;-<span class="st"> </span><span class="kw">st_nn</span>(yose_campgrnds_utm, yose_trails_utm, <span class="dt">sparse =</span> <span class="ot">TRUE</span>, <span class="dt">progress =</span> <span class="ot">FALSE</span>)</span>
<span id="cb23-23"><a href="#cb23-23"></a></span>
<span id="cb23-24"><a href="#cb23-24"></a>closest_trail_idx &lt;-<span class="st"> </span><span class="kw">unlist</span>(closest_trail_lst)</span>
<span id="cb23-25"><a href="#cb23-25"></a>closest_trail_idx</span></code></pre></div>
<pre><code>## Reading layer `yose_poi&#39; from data source `D:\Workshops\R-Spatial\rspatial_mod\outputs\rspatial_data\data&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 2720 features and 30 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: 246416.2 ymin: 4153717 xmax: 301510.7 ymax: 4208419
## projected CRS:  NAD83 / UTM zone 11N
## [1] TRUE
## Reading layer `Trails&#39; from data source `D:\Workshops\R-Spatial\rspatial_mod\outputs\rspatial_data\data\yose_trails.gdb&#39; using driver `OpenFileGDB&#39;
## Simple feature collection with 1074 features and 13 fields
## geometry type:  MULTILINESTRING
## dimension:      XY
## bbox:           xmin: 245134 ymin: 4153668 xmax: 323239.7 ymax: 4250703
## projected CRS:  NAD83 / UTM zone 11N
##  [1] 610 117 275 467 504 961 237 432 343 563 541 603 566 927  72</code></pre>
<p>Plot the results:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co">## Plot results</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>rainbow_cols &lt;-<span class="st"> </span><span class="kw">rainbow</span>(<span class="kw">nrow</span>(yose_campgrnds_utm), <span class="dt">end=</span><span class="dv">5</span><span class="op">/</span><span class="dv">6</span>)</span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="kw">tm_shape</span>(yose_trails_utm, <span class="dt">bbox=</span>yose_campgrnds_utm) <span class="op">+</span><span class="st"> </span></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="st">  </span><span class="kw">tm_lines</span>(<span class="dt">col=</span><span class="st">&quot;gray90&quot;</span>) <span class="op">+</span></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="st">  </span><span class="kw">tm_shape</span>(yose_trails_utm <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(closest_trail_idx)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="st">  </span><span class="kw">tm_lines</span>(<span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="st">  </span><span class="kw">tm_shape</span>(yose_campgrnds_utm) <span class="op">+</span><span class="st"> </span></span>
<span id="cb25-8"><a href="#cb25-8"></a><span class="st">  </span><span class="kw">tm_symbols</span>(<span class="dt">col=</span><span class="st">&quot;POINAME&quot;</span>, <span class="dt">palette =</span> rainbow_cols, <span class="dt">size=</span><span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb25-9"><a href="#cb25-9"></a><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">legend.show =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<p><img src="spatial-queries_files/figure-slidy/nngeo_plot_results_klippy-1.png" width="768" /></p>
</div>
<div id="spatial-join" class="slide section level1">
<h1>Spatial Join</h1>
<p>Spatial join is like <code>dplyr::left_join()</code>, but instead of joining two tables on a matching column you join them based on their spatial relationship (e.g., intersects).</p>
<p>You can do a spatial join with:</p>
<div class="indented2">
<tt><strong>st_join(<em>x</em>, <em>y</em>, <em>join</em>)</strong></tt>
</div>
<h2 id="example-find-the-vegetation-type-for-each-of-yosemites-campgrounds">Example: Find the vegetation type for each of Yosemite’s Campgrounds</h2>
<p>Import the vegetation layer and the dbf file which contains the legend:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="co">## Import the vegetation layer</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>yose_veg_utm &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn=</span><span class="st">&quot;./data&quot;</span>, <span class="dt">layer=</span><span class="st">&quot;veg37&quot;</span>) </span>
<span id="cb26-3"><a href="#cb26-3"></a></span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="co">## Import the legend</span></span>
<span id="cb26-5"><a href="#cb26-5"></a>dbf_fn =<span class="st"> </span><span class="kw">file.path</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;data&quot;</span>, <span class="st">&quot;veg37_alliances.dbf&quot;</span>)</span>
<span id="cb26-6"><a href="#cb26-6"></a><span class="kw">file.exists</span>(dbf_fn)</span>
<span id="cb26-7"><a href="#cb26-7"></a>yose_veg_leg &lt;-<span class="st"> </span>foreign<span class="op">::</span><span class="kw">read.dbf</span>(<span class="dt">file =</span> dbf_fn)</span>
<span id="cb26-8"><a href="#cb26-8"></a><span class="kw">glimpse</span>(yose_veg_utm)</span></code></pre></div>
<pre><code>## Reading layer `veg37&#39; from data source `D:\Workshops\R-Spatial\rspatial_mod\outputs\rspatial_data\data&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 6512 features and 26 fields
## geometry type:  POLYGON
## dimension:      XY
## bbox:           xmin: 246268.6 ymin: 4152706 xmax: 306269.9 ymax: 4229672
## projected CRS:  NAD83 / UTM zone 11N
## [1] TRUE
## Rows: 6,512
## Columns: 27
## $ AREA       &lt;dbl&gt; 1141684.308, 1182450.773, 8569824.715, 143326.612, 7157452.521, 3717547.479, 5311.212, 115763...
## $ PERIMETER  &lt;dbl&gt; 8249.203, 6247.234, 20526.994, 1990.976, 23259.286, 19649.970, 422.512, 29390.301, 1761.167, ...
## $ VEG37_     &lt;int&gt; 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 2...
## $ VEG37_ID   &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26...
## $ RIM_CODE   &lt;dbl&gt; 889, 60, 53, 889, 270, 637, 60, 524, 60, 529, 60, 615, 637, 889, 60, 529, 60, 899, 270, 60, 2...
## $ FIRE_REGIM &lt;chr&gt; &quot;whitebark pine - mountain hemlo&quot;, &quot;barren&quot;, &quot;eastside shrub&quot;, &quot;whitebark pine - mountain hem...
## $ W1         &lt;chr&gt; &quot;PIAL10&quot;, &quot;BARREN&quot;, &quot;ARTR10&quot;, &quot;PIAL10&quot;, &quot;TSME10&quot;, &quot;MEADOW&quot;, &quot;BARREN&quot;, &quot;PICO11&quot;, &quot;BARREN&quot;, &quot;LA...
## $ W2         &lt;chr&gt; NA, NA, &quot;MEADOW&quot;, NA, &quot;PICO11&quot;, &quot;SALIX&quot;, NA, NA, NA, NA, NA, &quot;PIAL10&quot;, &quot;SALIX&quot;, NA, NA, NA, N...
## $ W3         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ W4         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ W5         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ W6         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ W7         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ W8         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ DOMINANT   &lt;chr&gt; &quot;whitebark pine&quot;, &quot;barren&quot;, &quot;sagebrush&quot;, &quot;whitebark pine&quot;, &quot;mountain hemlock&quot;, &quot;meadow&quot;, &quot;bar...
## $ ALLIANCE   &lt;chr&gt; &quot;a1&quot;, &quot;z1&quot;, &quot;g1&quot;, &quot;a1&quot;, &quot;a5&quot;, &quot;h1&quot;, &quot;z1&quot;, &quot;a2&quot;, &quot;z1&quot;, &quot;z2&quot;, &quot;z1&quot;, &quot;a3&quot;, &quot;h1&quot;, &quot;a1&quot;, &quot;z1&quot;, &quot;z2...
## $ FORMATION  &lt;chr&gt; &quot;a&quot;, &quot;z&quot;, &quot;g&quot;, &quot;a&quot;, &quot;a&quot;, &quot;h&quot;, &quot;z&quot;, &quot;a&quot;, &quot;z&quot;, &quot;z&quot;, &quot;z&quot;, &quot;a&quot;, &quot;h&quot;, &quot;a&quot;, &quot;z&quot;, &quot;z&quot;, &quot;z&quot;, &quot;a&quot;, &quot;a&quot;...
## $ ACRES      &lt;int&gt; 26, 27, 197, 3, 164, 85, 0, 266, 2, 50, 3, 21, 164, 6, 8, 4, 1867, 15, 36, 42, 31, 12, 3, 6, ...
## $ FMP_TYPE   &lt;chr&gt; &quot;sa1&quot;, &quot;ba1&quot;, &quot;sc1&quot;, &quot;sa1&quot;, &quot;sa1&quot;, &quot;sa2&quot;, &quot;ba1&quot;, &quot;sa2&quot;, &quot;ba1&quot;, &quot;ba2&quot;, &quot;ba1&quot;, &quot;sa1&quot;, &quot;sa1&quot;, &quot;s...
## $ FMP_CODE   &lt;int&gt; 11, 1, 13, 11, 11, 12, 1, 12, 1, 2, 1, 11, 11, 11, 1, 2, 1, 11, 11, 1, 11, 11, 11, 11, 11, 12...
## $ UTMX_NAD27 &lt;dbl&gt; 273200.4, 272756.9, 272541.5, 272749.9, 273886.5, 272711.2, 272327.4, 272041.5, 272218.8, 273...
## $ UTMY_NAD27 &lt;dbl&gt; 4229343, 4229084, 4228585, 4228952, 4227944, 4228051, 4228794, 4227802, 4228640, 4228410, 422...
## $ MED_RI     &lt;int&gt; 187, 0, 30, 187, 187, 102, 0, 102, 0, 0, 0, 187, 187, 187, 0, 0, 0, 187, 187, 0, 187, 187, 18...
## $ MAX_RI     &lt;int&gt; 508, 0, 75, 508, 508, 163, 0, 163, 0, 0, 0, 508, 508, 508, 0, 0, 0, 508, 508, 0, 508, 508, 50...
## $ HT2LC      &lt;int&gt; 1, 0, 0, 1, 2, 0, 0, 2, 0, 0, 0, 2, 0, 1, 0, 0, 0, 2, 2, 0, 2, 0, 1, 1, 2, 0, 0, 1, 0, 2, 2, ...
## $ HECTARES   &lt;dbl&gt; 10.607, 10.985, 79.617, 1.332, 66.495, 34.537, 0.049, 107.548, 0.617, 20.365, 1.414, 8.572, 6...
## $ geometry   &lt;POLYGON [m]&gt; POLYGON ((272916.2 4229510,..., POLYGON ((272916.2 4229510,..., POLYGON ((272998.2 42...</code></pre>
<p>Next, we join the legend fields to the polygon layer based on a common column:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co">## Join the legend to the attribute table of the vegetation sf</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>yose_veg_utm &lt;-<span class="st"> </span>yose_veg_utm <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(yose_veg_leg, <span class="dt">by =</span> <span class="st">&quot;ALLIANCE&quot;</span>)</span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="kw">glimpse</span>(yose_veg_utm)</span>
<span id="cb28-4"><a href="#cb28-4"></a></span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="co">## Plot it</span></span>
<span id="cb28-6"><a href="#cb28-6"></a><span class="kw">tm_shape</span>(yose_veg_utm) <span class="op">+</span></span>
<span id="cb28-7"><a href="#cb28-7"></a><span class="st">  </span><span class="kw">tm_fill</span>(<span class="dt">col =</span> <span class="st">&quot;VEGETATION&quot;</span>) <span class="op">+</span></span>
<span id="cb28-8"><a href="#cb28-8"></a><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">title =</span> <span class="st">&quot;Yosemite NP Vegetation Classes&quot;</span>,</span>
<span id="cb28-9"><a href="#cb28-9"></a>            <span class="dt">legend.outside =</span> <span class="ot">TRUE</span>,</span>
<span id="cb28-10"><a href="#cb28-10"></a>            <span class="dt">legend.outside.position =</span> <span class="st">&quot;right&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Number of levels of the variable &quot;VEGETATION&quot; is 38, which is larger than max.categories (which is 30), so
## levels are combined. Set tmap_options(max.categories = 38) in the layer function to show all levels.</code></pre>
<pre><code>## Some legend labels were too wide. These labels have been resized to 0.45, 0.30, 0.56, 0.62, 0.39, 0.31, 0.36, 0.52, 0.48, 0.34, 0.58, 0.62, 0.41, 0.36, 0.64, 0.63, 0.49, 0.34, 0.62, 0.51, 0.40, 0.43, 0.31, 0.43, 0.31, 0.43. Increase legend.width (argument of tm_layout) to make the legend wider and therefore the labels larger.</code></pre>
<p><img src="spatial-queries_files/figure-slidy/imp_veg2_klippy-1.png" width="768" /></p>
<pre><code>## Rows: 6,512
## Columns: 29
## $ AREA       &lt;dbl&gt; 1141684.308, 1182450.773, 8569824.715, 143326.612, 7157452.521, 3717547.479, 5311.212, 115763...
## $ PERIMETER  &lt;dbl&gt; 8249.203, 6247.234, 20526.994, 1990.976, 23259.286, 19649.970, 422.512, 29390.301, 1761.167, ...
## $ VEG37_     &lt;int&gt; 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 2...
## $ VEG37_ID   &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26...
## $ RIM_CODE   &lt;dbl&gt; 889, 60, 53, 889, 270, 637, 60, 524, 60, 529, 60, 615, 637, 889, 60, 529, 60, 899, 270, 60, 2...
## $ FIRE_REGIM &lt;chr&gt; &quot;whitebark pine - mountain hemlo&quot;, &quot;barren&quot;, &quot;eastside shrub&quot;, &quot;whitebark pine - mountain hem...
## $ W1         &lt;chr&gt; &quot;PIAL10&quot;, &quot;BARREN&quot;, &quot;ARTR10&quot;, &quot;PIAL10&quot;, &quot;TSME10&quot;, &quot;MEADOW&quot;, &quot;BARREN&quot;, &quot;PICO11&quot;, &quot;BARREN&quot;, &quot;LA...
## $ W2         &lt;chr&gt; NA, NA, &quot;MEADOW&quot;, NA, &quot;PICO11&quot;, &quot;SALIX&quot;, NA, NA, NA, NA, NA, &quot;PIAL10&quot;, &quot;SALIX&quot;, NA, NA, NA, N...
## $ W3         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ W4         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ W5         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ W6         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ W7         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ W8         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ DOMINANT   &lt;chr&gt; &quot;whitebark pine&quot;, &quot;barren&quot;, &quot;sagebrush&quot;, &quot;whitebark pine&quot;, &quot;mountain hemlock&quot;, &quot;meadow&quot;, &quot;bar...
## $ ALLIANCE   &lt;chr&gt; &quot;a1&quot;, &quot;z1&quot;, &quot;g1&quot;, &quot;a1&quot;, &quot;a5&quot;, &quot;h1&quot;, &quot;z1&quot;, &quot;a2&quot;, &quot;z1&quot;, &quot;z2&quot;, &quot;z1&quot;, &quot;a3&quot;, &quot;h1&quot;, &quot;a1&quot;, &quot;z1&quot;, &quot;z2...
## $ FORMATION  &lt;chr&gt; &quot;a&quot;, &quot;z&quot;, &quot;g&quot;, &quot;a&quot;, &quot;a&quot;, &quot;h&quot;, &quot;z&quot;, &quot;a&quot;, &quot;z&quot;, &quot;z&quot;, &quot;z&quot;, &quot;a&quot;, &quot;h&quot;, &quot;a&quot;, &quot;z&quot;, &quot;z&quot;, &quot;z&quot;, &quot;a&quot;, &quot;a&quot;...
## $ ACRES      &lt;int&gt; 26, 27, 197, 3, 164, 85, 0, 266, 2, 50, 3, 21, 164, 6, 8, 4, 1867, 15, 36, 42, 31, 12, 3, 6, ...
## $ FMP_TYPE   &lt;chr&gt; &quot;sa1&quot;, &quot;ba1&quot;, &quot;sc1&quot;, &quot;sa1&quot;, &quot;sa1&quot;, &quot;sa2&quot;, &quot;ba1&quot;, &quot;sa2&quot;, &quot;ba1&quot;, &quot;ba2&quot;, &quot;ba1&quot;, &quot;sa1&quot;, &quot;sa1&quot;, &quot;s...
## $ FMP_CODE   &lt;int&gt; 11, 1, 13, 11, 11, 12, 1, 12, 1, 2, 1, 11, 11, 11, 1, 2, 1, 11, 11, 1, 11, 11, 11, 11, 11, 12...
## $ UTMX_NAD27 &lt;dbl&gt; 273200.4, 272756.9, 272541.5, 272749.9, 273886.5, 272711.2, 272327.4, 272041.5, 272218.8, 273...
## $ UTMY_NAD27 &lt;dbl&gt; 4229343, 4229084, 4228585, 4228952, 4227944, 4228051, 4228794, 4227802, 4228640, 4228410, 422...
## $ MED_RI     &lt;int&gt; 187, 0, 30, 187, 187, 102, 0, 102, 0, 0, 0, 187, 187, 187, 0, 0, 0, 187, 187, 0, 187, 187, 18...
## $ MAX_RI     &lt;int&gt; 508, 0, 75, 508, 508, 163, 0, 163, 0, 0, 0, 508, 508, 508, 0, 0, 0, 508, 508, 0, 508, 508, 50...
## $ HT2LC      &lt;int&gt; 1, 0, 0, 1, 2, 0, 0, 2, 0, 0, 0, 2, 0, 1, 0, 0, 0, 2, 2, 0, 2, 0, 1, 1, 2, 0, 0, 1, 0, 2, 2, ...
## $ HECTARES   &lt;dbl&gt; 10.607, 10.985, 79.617, 1.332, 66.495, 34.537, 0.049, 107.548, 0.617, 20.365, 1.414, 8.572, 6...
## $ VEGETATION &lt;fct&gt; &quot;whitebark pine forest&quot;, &quot;rock outcrop, dome&quot;, &quot;montane chaparral&quot;, &quot;whitebark pine forest&quot;, ...
## $ CWHR       &lt;fct&gt; SCN, BAR, MCP, SCN, SCN, WTM, BAR, LPN, BAR, LAC, BAR, SCN, WTM, SCN, BAR, LAC, BAR, SCN, SCN...
## $ geometry   &lt;POLYGON [m]&gt; POLYGON ((272916.2 4229510,..., POLYGON ((272916.2 4229510,..., POLYGON ((272998.2 42...</code></pre>
<p>Next, we do a spatial join to get the vegetation type for each campground:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="co">## Spatial join three fields from the veg layer</span></span>
<span id="cb32-2"><a href="#cb32-2"></a>yose_campgrnds_veg &lt;-<span class="st"> </span>yose_campgrnds_utm <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="st">  </span><span class="kw">st_join</span>(yose_veg_utm <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="st">            </span><span class="kw">select</span>(ALLIANCE, DOMINANT, VEGETATION, CWHR),</span>
<span id="cb32-5"><a href="#cb32-5"></a>          <span class="dt">join =</span> st_intersects) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb32-6"><a href="#cb32-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">VEGETATION =</span> <span class="kw">as.character</span>(VEGETATION))</span>
<span id="cb32-7"><a href="#cb32-7"></a></span>
<span id="cb32-8"><a href="#cb32-8"></a><span class="co">## View the columns in the campgrounds point layer</span></span>
<span id="cb32-9"><a href="#cb32-9"></a><span class="kw">names</span>(yose_campgrnds_utm)</span>
<span id="cb32-10"><a href="#cb32-10"></a></span>
<span id="cb32-11"><a href="#cb32-11"></a><span class="co">## View the columns in the campgrounds point layer</span></span>
<span id="cb32-12"><a href="#cb32-12"></a><span class="kw">names</span>(yose_campgrnds_veg)</span></code></pre></div>
<pre><code>## [1] &quot;POINAME&quot;  &quot;geometry&quot;
## [1] &quot;POINAME&quot;    &quot;ALLIANCE&quot;   &quot;DOMINANT&quot;   &quot;VEGETATION&quot; &quot;CWHR&quot;       &quot;geometry&quot;</code></pre>
<p>Plot them:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="co">## Plot it</span></span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="kw">tm_shape</span>(yose_bnd_utm) <span class="op">+</span></span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="st">  </span><span class="kw">tm_polygons</span>() <span class="op">+</span></span>
<span id="cb34-4"><a href="#cb34-4"></a><span class="kw">tm_shape</span>(yose_campgrnds_veg) <span class="op">+</span></span>
<span id="cb34-5"><a href="#cb34-5"></a><span class="st">  </span><span class="kw">tm_symbols</span>(<span class="dt">col =</span> <span class="st">&quot;VEGETATION&quot;</span>) <span class="op">+</span></span>
<span id="cb34-6"><a href="#cb34-6"></a><span class="kw">tm_layout</span>(<span class="dt">title =</span> <span class="st">&quot;Yosemite Campgrounds&quot;</span>,</span>
<span id="cb34-7"><a href="#cb34-7"></a>          <span class="dt">legend.outside =</span> <span class="ot">TRUE</span>,</span>
<span id="cb34-8"><a href="#cb34-8"></a>          <span class="dt">legend.outside.position =</span> <span class="st">&quot;right&quot;</span>)</span></code></pre></div>
<pre><code>## Some legend labels were too wide. These labels have been resized to 0.65. Increase legend.width (argument of tm_layout) to make the legend wider and therefore the labels larger.</code></pre>
<p><img src="spatial-queries_files/figure-slidy/spatial_join2_klippy-1.png" width="768" /></p>
</div>
<div id="summary" class="slide section level1">
<h1>Summary</h1>
<p>In this session we saw how to:</p>
<div class="compact">
<ul>
<li>apply <code>sf</code> functions that test for spatial relationships<br />
</li>
<li>use the results of spatial relationship tests to select features<br />
</li>
<li>generate random points within an irregular polygon<br />
</li>
<li>locate the nearest feature with <code>st_nn()</code></li>
</ul>
</div>
<div class="infobox">
<p>Additional Resources</p>
<div class="indented1">
<p><a href="https://geocompr.robinlovelace.net/spatial-operations.html" target="_blank">Geocomputation with R Ch4: Spatial Data Operations</a>. Robin Lovelace, Jakub Nowosad, Jannes Muenchow</p>
</div>
</div>
<!--- additional resources --->
<p>
<br/>
<hr/>
<strong>Next: </strong> <a href="branches_loops.html">Automation and Batch Processing</a>
</p>
</div>

  <!-- dynamically load mathjax for compatibility with self-contained -->
  <script>
    (function () {
      var script = document.createElement("script");
      script.type = "text/javascript";
      script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
      document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>

</body>
</html>
